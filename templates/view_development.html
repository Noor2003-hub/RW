{% extends "layout.html" %}

{% block title %}
Development Charts
{% endblock %}

{% block main %}
{% if get_flashed_messages() %}
<a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Ù‡Ù„ ØªÙ… Ø±ØµØ¯ ØªØ£Ø®Ø± Ù„Ø¯Ù‰ Ø·ÙÙ„ÙƒØŸ</a>
    <!-- Terms and Conditions Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">Ù‡Ù„ ØªÙ… Ø±ØµØ¯ ØªØ£Ø®Ø± Ù„Ø¯Ù‰ Ø·ÙÙ„ÙƒØŸ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" dir="rtl">
                    <ul>

                        <li>Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ¯Ù„ Ø¹Ù„Ù‰ Ø§Ù† Ø·ÙÙ„Ùƒ Ù…ØªØ£Ø®Ø± Ø¨Ù…Ù‚Ø¯Ø§Ø± Ø¹Ø§Ù…ÙŠÙ† Ø¹Ù† Ø¹Ù…Ø±Ù‡ Ø£Ùˆ Ø§ÙƒØ«Ø±, Ù‡Ø°Ø§ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ ÙˆØ¬Ø¯ Ø­Ø§Ø¬Ø² Ù„Ù†Ù…Ùˆ Ø§Ù„Ø·ÙÙ„ Ùˆ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯Ù‡ Ùˆ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡</li>
                        <li>Ø­Ø§ÙˆÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„ÙŠ ØªØ£Ø®Ø± ÙÙŠÙ‡ Ø§Ù„Ø·ÙÙ„ Ø¨Ù…Ù‚Ø¯Ø§Ø± Ø¹Ø§Ù…ÙŠÙ† Ø£Ùˆ Ø§ÙƒØ«Ø± Ùˆ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù† Ø§Ù„Ø·ÙÙ„ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨ØªÙ„Ùƒ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</li>
                        <li><strong>ÙÙŠ Ø­Ø§Ù„ ØªØ£ÙƒØ¯Ùƒ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ£Ø®Ø± ÙÙŠ Ù…Ø¬Ø§Ù„ Ù…Ø¹ÙŠÙ† Ø£Ùˆ Ø§ÙƒØ«Ø±, ÙŠÙ†ØµØ­ Ø¨Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ© Ù…Ù† Ø§Ø­Ø¯ Ø§Ù„Ù…Ø®ØªØµÙŠÙ† Ø¹Ø¨Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø®Ø§Ø±Ø¬Ù‡.</strong></li>
                        <li>ÙŠÙ†ØµØ­ Ø¨Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙÙ„, ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø¨Ø·Ø±ÙŠÙ‚Ø© ÙØ¹Ø§Ù„Ø© Ø§ÙƒØ«Ø± ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙÙ„ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endif %}
<h2 dir="rtl">ğŸ“ˆ Ù…Ø®Ø·Ø·Ø§Øª Ø¨ÙŠØ§Ù†ÙŠØ©</h2>
<p>ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª ÙÙŠ ØªÙˆØ¶ÙŠØ­ Ù…Ø¯Ù‰ ØªÙ‚Ø¯Ù… Ø·ÙÙ„Ùƒ ÙÙŠ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù:</p>

<!-- Section 2: Pie Charts -->
<style>
    .pie-chart {
        max-width: 200px; /* Default size */
        max-height: 200px; /* Default size */
    }
</style>

<div class="container mt-5">
    <h3>Ù…Ø®Ø·Ø·Ø§Øª Ø¯Ø§Ø¦Ø±ÙŠØ©</h3>
    <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
        {% for category, color, last_percentage in zipped_data %}
        <div style="margin: 10px;">
            <canvas id="pieChart_{{ loop.index }}" class="pie-chart" style="background-color:rgba(255, 255, 255, 0.2);"></canvas>
        </div>
        {% endfor %}
    </div>
</div>


<!-- Section 3: Line Chart -->
<div class="container mt-5">
    <h3>Ù…Ø®Ø·Ø· Ø®Ø·ÙŠ</h3>
    <label for="timeRange">Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„ÙˆÙ‚Øª:</label>
    <div style="text-align: center;">
    <button {%if not time_range=='week' and not time_range is none%}style="background-color:gray;"{%endif%} onclick="changeTimeRange('week')">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
    <button {%if not time_range=='month'%}style="background-color:gray;"{%endif%}onclick="changeTimeRange('month')">Ø§Ù„Ø´Ù‡Ø±</button>
    <button {%if not time_range=='year'%}style="background-color:gray;"{%endif%}onclick="changeTimeRange('year')">Ø§Ù„Ø³Ù†Ø©</button>
</div>
</div>

<br>
<div style="display: flex; justify-content: center; align-items: center; height: 80vh;">
    <canvas id="lineChart" style="height:200%;width:200%; background-color:rgba(255, 255, 255, 0.5);"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Function to change the time range and reload the data
    function changeTimeRange(range) {
        window.location.href = '/view_development?time_range=' + range;
    }

    // Prepare the line chart data based on the existing organized_data
    const lineData = {
        labels: [],  // Initialize empty labels
        datasets: [
            {% for category, color, last_percentage in zipped_data %}
            {
                label: '{{ category }}',
                data: [],  // Initialize empty data
                borderColor: '{{ color[0] }}',
                backgroundColor: '{{ color[1] }}',
            }
            {% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };

    // Populate lineData.labels and lineData.datasets with actual dates and percentages
    const dataa = {{ dataa | tojson }};
    for (const category in dataa) {
        for (const record of dataa[category]) {
            const date = record.time;
            const percentage = record.percentage;

            // Only push to labels if it's not already present
            if (!lineData.labels.includes(date)) {
                lineData.labels.push(date);
            }

            // Find the index of the category dataset
            const datasetIndex = lineData.datasets.findIndex(dataset => dataset.label === category);
            if (datasetIndex !== -1) {
                // Fill the data for the specific date
                lineData.datasets[datasetIndex].data.push(percentage);
            }
        }
    }

    // Line chart configuration
    const lineConfig = {
        type: 'line',
        data: lineData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: 16 // Increase legend label font size
                        }
                    }
                },
                title: {
                    display: true,
    {%if time_range=='month'%}
        text: 'Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø®Ø·ÙŠ Ù„ØªØ·ÙˆØ± Ø·ÙÙ„Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
        {%elif time_range=='year'%}
        text: 'Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø®Ø·ÙŠ Ù„ØªØ·ÙˆØ± Ø·ÙÙ„Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…',
        {%else%}
        text: 'Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø®Ø·ÙŠ Ù„ØªØ·ÙˆØ± Ø·ÙÙ„Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ø¨ÙˆØ¹',
        {%endif%}

                    font: {
                        size: 20 // Increase title font size
                    }
                }
            },
            scales: {
                x: {
                    offset: true,
                    ticks: {
                        font: {
                            size: 14
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    min: 0,
                    max: 100,
                    ticks: {
                        font: {
                            size: 14
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            elements: {
                point: {
                    radius: 6,
                    hoverRadius: 8,
                }
            }
        }
    };

    // Pie chart configurations
    {% for category, color, last_percentage in zipped_data %}
{% set rounded_percentage = last_percentage|round(2) %}
const pieLabels_{{ loop.index }} = ['Ù…ÙƒØªÙ…Ù„', 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'];
const pieData_{{ loop.index }} = {
    labels: pieLabels_{{ loop.index }},
    datasets: [
        {
            label: '{{ category }}',
            data: [{{ rounded_percentage }}, 100 - {{ rounded_percentage }}],
            backgroundColor: [
                '{{ color[1] }}',
                '#f0f0f0'
            ],
            hoverOffset: 10
        }
    ]
};

const pieConfig_{{ loop.index }} = {
    type: 'pie',
    data: pieData_{{ loop.index }},
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    font: {
                        size: 14
                    }
                }
            },
            title: {
                display: true,
                text: '{{ category }} : {{ rounded_percentage }}%',
                font: {
                    size: 17
                }
            }
        },
        layout: {
            padding: {
                top: 10,
                bottom: 10
            }
        }
    }
};
{% endfor %}


    // Render the charts
    window.onload = function() {
        // Render line chart
        const lineCtx = document.getElementById('lineChart').getContext('2d');
        new Chart(lineCtx, lineConfig);

        // Render each pie chart
        {% for category, color, last_percentage in zipped_data %}
        const pieCtx_{{ loop.index }} = document.getElementById('pieChart_{{ loop.index }}').getContext('2d');
        new Chart(pieCtx_{{ loop.index }}, pieConfig_{{ loop.index }});
        {% endfor %}
    };
</script>

{% endblock %}
